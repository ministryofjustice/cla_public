version: 2.1

orbs:
  aws-cli: circleci/aws-cli@4.1 # use v4 of this orb
  aws-ecr: circleci/aws-ecr@9.0 # this orb doesn't support OIDC v2, so we use aws-cli to authenticate

# ------------------
# EXECUTORS
# these are ones we use rather than one from rom the orb
# ------------------

executors:
  cloud-platform-executor:
    docker:
      - image: ministryofjustice/cloud-platform-tools:2.1


# ------------------
#
# REFERENCES
#
# ------------------

references:
  install_helm: &install_helm
      run:
        name: Install helm v3
        command: |
          wget https://get.helm.sh/helm-v3.2.4-linux-amd64.tar.gz
          tar -zxvf helm-v3.2.4-linux-amd64.tar.gz
          mv linux-amd64/helm /usr/local/bin/helm

jobs:

  dnstest_deploy:
    executor: cloud-platform-executor
    steps:
      - checkout
      - *install_helm
      - run:
          name: Authenticate with cluster
          command: .circleci/authenticate_with_kubernetes_cluster
      - deploy:
          name: Deploy laa-cla-public to dnstest
          command: |
            source .circleci/define_build_environment_variables
            ./bin/dnstest_deploy.sh

workflows:
  version: 2
  deploy_dns_test_with_latest_image:
    jobs:
      - dnstest_deploy:
          context:
            - laa-cla-public
            - laa-cla-public-dnstest
          name: dnstest_deploy_branch
          filters:
            branches:
              only:
                - LGA-3471-dsn-transfer-test

