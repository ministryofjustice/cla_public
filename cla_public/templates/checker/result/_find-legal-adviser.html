{% import "macros/form.html" as Form %}
{% import "macros/element.html" as Element %}

{% macro category_information(category) %}
  {% if category == 'hlpas' %}
    <p class="govuk-body">
      {% trans %}If you cannot find a legal adviser to help you, contact Civil Legal advice.
      Tell them that you qualify for housing loss prevention advice.{% endtrans %}
    </p>
  {% elif category == 'clinneg' %}
    <p class="govuk-body">
    {% trans %}You will usually only get legal aid for advice about
      clinical negligence if your child has suffered a brain injury during pregnancy,
      birth or in the first 8 weeks of life.{% endtrans %}
    </p>
  {% elif category == 'pi' %}
    <p class="govuk-body">
    {% trans %}You may be able to get legal aid in exceptional cases. You
      could seek advice from a legal adviser about whether an application
      might succeed in your case and how to apply.{% endtrans %}
    </p>
  {% endif %}
{% endmacro %}

{% macro category_caption(category) %}
  {% if category %}
    {% if category == 'aap' %}
        <span class="govuk-caption-l govuk-!-margin-bottom-6">{% trans %}For trouble with the police and public authorities{% endtrans %}</span>
    {% elif category == 'hlpas' %}
        <span class="govuk-caption-l govuk-!-margin-bottom-6">For the {{category_name}}</span>
    {% else %}
      <span class="govuk-caption-l govuk-!-margin-bottom-6">For {{category_name.lower()}}</span>
    {% endif %}
  {% endif %}
{% endmacro %}

{% if data and data.count and data.count > 0 %}
  <h1 class="govuk-heading-xl govuk-!-margin-bottom-2">
    {{ _('Contact a legal advsior') }}
    {{ category_caption(category) }}
  </h1>


  <p class="govuk-body">You can contact any legal adviser from this list.</p>
  <p class="govuk-body">Your adviser will check whether you qualify for legal aid <strong>at no cost to you</strong> by asking about your problem and your finances. In some cases you may need to pay a contribution towards your legal aid.</p>
  {{ category_information(category) }}

<p id="aria-satisfaction-survey" class="govuk-body">
  {% trans -%}
    <a class="govuk-link" href="https://www.gov.uk/done/check-if-civil-legal-advice-can-help-you">What did you think of this service?</a> (takes 30 seconds)
  {%- endtrans %}
</p>

  {% if data.origin.postcode %}
    <p class="govuk-body">Results in order of closeness to <strong>{{data.origin.postcode}}</strong></p>
  {% endif %}

  {% for item in data.results %}
  <div>
    <hr class="govuk-section-break govuk-section-break--visible govuk-!-margin-bottom-4 govuk-!-margin-top-4">
    <span class="govuk-caption-m govuk-!-margin-bottom-2">{% trans miles=item.distance|round(2) %}{{ miles }} miles away{% endtrans %}</span>
    <p class="govuk-body-l govuk-!-font-weight-bold govuk-!-margin-bottom-2">{{ item.organisation.name }} </p>
    <p class="govuk-body govuk-!-margin-bottom-2">Telephone: {{ item.telephone }}</p>
    {% if item.location.address %}
      <p class="govuk-body govuk-!-margin-bottom-2">Address: {{ item.location.address}}, {{item.location.city }}, {{ item.location.postcode }}</p>
    {% endif %}
    {% if item.organisation.website %}
      <p class="govuk-body govuk-!-margin-bottom-2">Website: <a target="_blank" class="govuk-link" href='http://{{ item.organisation.website }}'> {{ item.organisation.website }} (opens in a new tab)</a></p>
    {% endif %}
      <p class="govuk-body govuk-!-margin-bottom-2"><a target="_blank" class="govuk-link" href='https://www.google.com/maps/dir/?api=1&origin={{ data.origin.postcode }}&destination={{ item.location.address }}, {{ item.location.postcode }}'>Map and directions (opens in a new tab)</a></p>
  </div>

  {% endfor %}

  <hr class="govuk-section-break govuk-section-break--visible govuk-!-margin-bottom-4 govuk-!-margin-top-4">

  <nav class="govuk-pagination" aria-label="Pagination">
    {% if data.current_page | int != 1 %}
    <div class="govuk-pagination__prev">
      <a class="govuk-link govuk-pagination__link" href={{ url_for( request.endpoint, postcode=request.args.postcode, category=request.args.category, page=data.current_page | int - 1 )}} rel="prev">
        <svg class="govuk-pagination__icon govuk-pagination__icon--prev" xmlns="http://www.w3.org/2000/svg" height="13" width="15" aria-hidden="true" focusable="false" viewBox="0 0 15 13">
          <path d="m6.5938-0.0078125-6.7266 6.7266 6.7441 6.4062 1.377-1.449-4.1856-3.9768h12.896v-2h-12.984l4.2931-4.293-1.414-1.414z"></path>
        </svg>
        <span class="govuk-pagination__link-title">
          Previous<span class="govuk-visually-hidden"> page</span>
        </span>
      </a>
    </div>
    {% endif %}
    <ul class="govuk-pagination__list">
      {% for page_number in range(1, data.num_pages + 1) %}
        {% if page_number == data.current_page | int %}
          <li class="govuk-pagination__item govuk-pagination__item--current">
            <a class="govuk-link govuk-pagination__link" href={{ url_for( request.endpoint, postcode=request.args.postcode, category=request.args.category, page=page_number)}} aria-label="Page {{ page_number }}">
              {{ page_number }}
            </a>
          </li>
          {% else %}
          <li class="govuk-pagination__item">
            <a class="govuk-link govuk-pagination__link" href={{ url_for( request.endpoint, postcode=request.args.postcode, category=request.args.category, page=page_number )}} aria-label="Page {{ page_number }}">
              {{ page_number }}
            </a>
          </li>
        {% endif %}
      {% endfor %}
    </ul>
    {% if data.current_page | int != data.num_pages | int %}
      <div class="govuk-pagination__next">
        <a class="govuk-link govuk-pagination__link" href={{ url_for( request.endpoint, postcode=request.args.postcode, category=request.args.category, page=data.current_page | int + 1 )}} rel="next">
          <span class="govuk-pagination__link-title">
            Next<span class="govuk-visually-hidden"> page</span>
          </span>
          <svg class="govuk-pagination__icon govuk-pagination__icon--next" xmlns="http://www.w3.org/2000/svg" height="13" width="15" aria-hidden="true" focusable="false" viewBox="0 0 15 13">
            <path d="m8.107-0.0078125-1.4136 1.414 4.2926 4.293h-12.986v2h12.896l-4.1855 3.9766 1.377 1.4492 6.7441-6.4062-6.7246-6.7266z"></path>
          </svg>
        </a>
      </div>
    {% endif %}
  </nav>

  {% if postcode_info.is_scottish_postcode
    or postcode_info.is_ni_postcode
    or postcode_info.is_mann_postcode
    or postcode_info.is_jersey_postcode
    or postcode_info.is_guernsey_postcode
    %}
    <div class="govuk-warning-text">
      <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
      <strong class="govuk-warning-text__text">
        <span class="govuk-warning-text__assistive">Warning </span>
        {% if postcode_info.is_scottish_postcode %}
          {% trans
            link=Element.link_same_window('https://www.mygov.scot/legal-aid/', _('mygov.scot'), True)
          %}Legal Aid is different in Scotland. Visit {{ link }} for more information.{% endtrans %}
        {% elif postcode_info.is_ni_postcode %}
          {% trans
            link=Element.link_same_window('https://www.nidirect.gov.uk/articles/legal-aid-schemes', _('nidirect.gov.uk'), True)
          %}Legal Aid is different in Northern Ireland. Visit {{ link }} for more information.{% endtrans %}
        {% elif postcode_info.is_mann_postcode %}
          {% trans
            link=Element.link_same_window('https://www.gov.im/categories/benefits-and-financial-support/legal-aid/', _('gov.im'), True)
          %}Legal Aid is different on the Isle of Man. Visit {{ link }} for more information.{% endtrans %}
        {% elif postcode_info.is_jersey_postcode  %}
          {% trans
            link=Element.link_same_window('https://www.legalaid.je/', _('legalaid.je'), True)
          %}Legal Aid is different in Jersey. Visit {{ link }} for more information.{% endtrans %}
        {% elif postcode_info.is_guernsey_postcode %}
          {% trans
            link=Element.link_same_window('https://www.gov.gg/legalaid', _('gov.gg'), True)
          %}Legal Aid is different in Guernsey. Visit {{ link }} for more information.{% endtrans %}
        {% endif %}
      </strong>
    </div>
  {% endif %}

  {% set find_legal_advisor_subtitle = _('Search again') %}

{% else %}

  {% if 'count' in data and data.count == 0 %}
    {% call Element.alert('error', title=_('No results')) %}
      <div class="govuk-error-summary__body">
        <ul class="govuk-list govuk-error-summary__list">
          <li>
            <a href="#postcode">
              {% trans %}We couldn’t find any results for your search. We are constantly updating our records so please try again later.{% endtrans %}
            </a>
          </li>
        </ul>
      </div>
    {% endcall %}

    {% set postcode_error = true %}

  {% endif %}

  {% if form.postcode and form.postcode.errors %}
    {% if postcode_info.is_mann_postcode %}
      {% set error_text = _('No results returned for the Isle of Man, try a postcode in England or Wales') %}
    {% elif postcode_info.is_jersey_postcode %}
      {% set error_text = _('No results returned for Jersey, try a postcode in England or Wales') %}
    {% elif postcode_info.is_guernsey_postcode %}
      {% set error_text = _('No results returned for Guernsey, try a postcode in England or Wales') %}
    {% else %}
      {% set error_text = form.postcode.errors[0] %}
    {% endif %}
    {% call Element.alert('error') %}
      <div class="govuk-error-summary__body">
        <ul class="govuk-list govuk-error-summary__list">
          <li>
            <a href="#postcode">{{ error_text }}</a>
          </li>
        </ul>
      </div>
    {% endcall %}
  {% endif %}

  {% if category == 'pi' %}
    <h1 class="govuk-heading-xl">
      {{ _('Legal aid is not usually available for advice about personal injury') }}
    </h1>
  {% else %}
    <h1 class="govuk-heading-xl govuk-!-margin-bottom-2">
      {{ _('Find a legal advisor') }}
    </h1>
    {{ category_caption(category) }}
  {% endif %}

  {% set find_legal_advisor_subtitle = _('Find a legal adviser') %}

{% endif %}


{% if 'postcode' not in request.args %}

  {{ category_information(category) }}

  <h2 class="govuk-heading-m">{{ _('What happens next') }}</h2>

  <p class="govuk-body">
    {% trans %}Your adviser will check whether you qualify for legal aid <strong>at no cost to you</strong> by asking about your problem and your finances.{% endtrans %}
    {% trans %}In some cases you may need to pay a contribution towards your legal aid.{% endtrans %}
  </p>

  {% if category == 'mentalhealth' %}
    <p class="govuk-body">
      {% trans %}If you’re applying for legal aid for a mental health issue,
        the requirements for the financial assessment are less rigorous than
        for other legal aid problems.{% endtrans %}
    </p>
  {% endif %}

  {% if find_legal_advisor_subtitle == _('Search again') %}
    <p class="govuk-body">
      <a class="govuk-link" href="https://www.gov.uk/done/check-if-civil-legal-advice-can-help-you" aria-labelledby="aria-satisfaction-survey">
        {% trans %}What did you think of this service?{% endtrans %}</a> {% trans %}(takes 30 seconds){% endtrans %}
    </p>
  {% endif %}

  {% if not hide_subtitle %}
    <h2 class="govuk-heading-m">{{ find_legal_advisor_subtitle }}</h2>
  {% endif %}

  <form method="GET">
    {% if postcode_error == true %}
      {{ Form.postcode_input(form.postcode, custom_error=_('Postcode not found')) }}
    {% elif error_text %}
      {{ Form.postcode_input(form.postcode, custom_error=error_text) }}
    {% else %}
      {{ Form.postcode_input(form.postcode) }}
    {% endif %}
    {% if category %}
      <div class="govuk-form-group ">
        <input class="govuk-input govuk-input--width-10 " id="category" type="hidden" name="category" value="{{ category }}" />
      </div>
    {% endif %}
    <button class="govuk-button" type="submit">
      {{ _('Search') }}
    </button>
  </form>
{% endif %}

<script nonce="{{ csp_nonce() }}">
  window.LABELS = {
    loading: "{{ _('Loading…') }}"
  };
</script>
