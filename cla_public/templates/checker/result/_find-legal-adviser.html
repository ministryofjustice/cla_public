{% import "macros/form.html" as Form %}
{% import "macros/element.html" as Element %}

<section class="find-legal-adviser">
  {% if not hide_subtitle %}
    <h2 class="govuk-heading-m">{{ _('Find a legal adviser') }}</h2>
  {% endif %}

  <form method="GET">
    {{ Form.postcode_input(form.postcode) }}
    {% if category %}
      <div class="govuk-form-group">
        <input class="govuk-input govuk-input--width-10" id="postcode" type="hidden" name="category" value="{{ category }}" />
      </div>
    {% endif %}
    <button class="govuk-button" type="submit">
      {{ _('Search') }}
    </button>
  </form>
  
  {% if request and request.args and request.args.get('postcode') and request.args.get('postcode')|length > 2 and request.args.get('postcode')|length < 9 %}
    {% set scot_postcode = "AB DD DG EH FK G1 G2 G3 G4 G5 G6 G7 G8 G9 G0 HS IV KA KW KY ML PA PH TD ZE" %}
    {% set ni_postcode = "BT" %}
    {% if request.args.get('postcode')[:2]|upper in scot_postcode 
    or request.args.get('postcode')[:2]|upper in ni_postcode
    or request.args.get('postcode')[:2]|upper == "IM" 
    or request.args.get('postcode')[:2]|upper == "GY" 
    or request.args.get('postcode')[:2]|upper == "JE"
    %}
      <div class="govuk-warning-text">
        <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
        <strong class="govuk-warning-text__text">
          <span class="govuk-warning-text__assistive">Warning</span>
          {% if request.args.get('postcode')[:2]|upper in scot_postcode %}
            Legal Aid is different in Scotland. Visit 
            <a class="govuk-link" href="https://www.mygov.scot/legal-aid/">mygov.scot</a> 
            for more information.
          {% elif request.args.get('postcode')[:2]|upper in ni_postcode %}
            Legal Aid is different in Northern Ireland. Visit 
            <a class="govuk-link" href="https://www.nidirect.gov.uk/articles/legal-aid-schemes">nidirect.gov.uk</a> 
            for more information.
          {% elif request.args.get('postcode')[:2]|upper == "IM" %}
            Legal Aid is different on the Isle of Man. Visit 
            <a class="govuk-link" href="https://www.gov.im/categories/benefits-and-financial-support/legal-aid/">gov.im</a> 
            for more information.
          {% elif request.args.get('postcode')[:2]|upper == "JE"  %}
            Legal Aid is different in Jersey. Visit 
            <a class="govuk-link" href="https://www.legalaid.je/">legalaid.je</a> 
            for more information.
          {% elif request.args.get('postcode')[:2]|upper == "GY" %}
            Legal Aid is different in Guernsey. Visit 
            <a class="govuk-link" href="https://www.gov.gg/legalaid">gov.gg</a> 
            for information about the process in Guernsey.
          {% endif %}
        </strong>
      </div>
    {% endif %}
  {% endif %}

  {% if data and data.count and data.count > 0 %}
    <p class="govuk-body">
      {% trans count=data.results|length %}Showing {{ count }} results around{% endtrans %}
      <strong class="govuk-!-font-weight-bold">{{ data.origin.postcode }}</strong>
      {% if category_name %}
        {{ _('for') }}
          <strong class="govuk-!-font-weight-bold">{{ category_name|lower }}</strong>.
      {% endif %}
    </p>
    
    <div class="search-results-container">
      {% if data.origin %}
        <div id="resultsMap" class="map" data-lat="{{ data.origin.point.coordinates[1] }}" data-lon="{{ data.origin.point.coordinates[0] }}"></div>
      {% else %}
        <div id="resultsMap" class="map"></div>
      {% endif %}
      <div class="search-results">
        <div class="search-results-list" data-current-page="{{ data.current_page }}">
          <ul class="org-list">
            {% for item in data.results %}
              <li class="org-list-item vcard" data-lat="{{ item.location.point.coordinates[1] }}" data-lon="{{ item.location.point.coordinates[0] }}" data-id="{{ loop.index }}">
                <header class="org-summary">
                  <h3 class="org-title">
                    <span class="marker">{{ loop.index }}</span>
                    <span class="fn org">{{ item.organisation.name }}</span>
                  </h3>
                  <div class="distance">
                    <span class="sr-only">{{ _('Distance') }}</span>
                    {% if data.origin %}
                      {% trans miles=item.distance|round(2) %}{{ miles }} miles{% endtrans %}
                    {% endif %}
                  </div>
                </header>
                <div class="org-details">
                  {% if item.categories|length %}
                    <div class="org-categories" role="list">
                      <div class="sr-only">{{ _('Categories of law') }}</div>
                      {% for cat in item.categories if cat %}
                        <span class="org-category" role="listitem">{{ cat }}</span>
                      {% endfor %}
                    </div>
                  {% endif %}
                  <p>
                    <span class="sr-only">{{ _('Address') }}:</span>
                    <span class="adr">
                      <span class="street-address">{{ item.location.address }}</span>
                      <span class="city">{{ item.location.city }}</span>
                      <span class="postal-code">{{ item.location.postcode }}</span>
                    </span>
                  </p>
                  <p>
                    <span>{{ _('Helpline') }}:</span>
                    <span class="tel">{{ item.telephone }}</span>
                  </p>
                  {% if item.organisation.website %}
                    <p>
                      <span>{{ _('Website') }}:</span>
                      {{ Element.link_new_window(item.organisation.website|human_to_url, item.organisation.website|url_to_human, is_external=True, **{'class': 'url'}) }}
                    </p>
                  {% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        </div>
        <nav class="search-results-pagination">
          <ul>
            {% if data.previous %}
              {% set prev_page = data.previous|query_to_dict('page') %}
              <li class="results-nav results-nav-prev">
                <a
                  href="{{ url_for(request.url_rule.endpoint,
                    postcode=request.args['postcode'],
                    page=prev_page,
                    category=category) }}"
                  data-page="{{prev_page}}"
                >
                  {{ _('Previous') }}
                </a>
              </li>
            {% endif %}
            {% if data.next %}
              {% set next_page = data.next|query_to_dict('page')|first %}
              <li class="results-nav results-nav-next">
                <a
                  href="{{ url_for(request.url_rule.endpoint,
                    postcode=request.args['postcode'],
                    page=next_page,
                    category=category) }}"
                  data-page="{{next_page}}"
                >
                  {{ _('Next') }}
                </a>
              </li>
            {% endif %}
          </ul>
        </nav>
      </div>
    </div>
  {% elif 'count' in data and data.count == 0 %}
    {% call Element.alert('error', title=_('No results')) %}
      <p class="govuk-body">
        {% trans %}We couldn't find any results for your search.
        We are constantly updating our records so please try again later.{% endtrans %}
      </p>
    {% endcall %}
  {% endif %}

  <script>
    window.LABELS = {
      loading: "{{ _('Loadingâ€¦') }}"
    };
  </script>

</section>
