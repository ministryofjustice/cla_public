{% if request.path.startswith('/result') %}
  {% extends 'checker/base.html' %}
{% else %}
  {% extends 'base.html' %}
{% endif %}

{% import "macros/form.html" as Form %}
{% import "macros/subform.html" as Subform %}
{% import "macros/element.html" as Element %}

{% set title = _('Contact Civil Legal Advice') %}
{% block page_title %}{{ title }}{% endblock %}

{% block inner_content %}
  {% block page_text %}
    {% if config.CONTACT_ONLY %}
      {% call Element.alert() %}
        <p class="govuk-body">{{ _('The full service is currently unavailable. However, you can still get in touch using the form below.') }}</p>
      {% endcall %}
    {% endif %}
    <h1 class="govuk-heading-xl">{{ title }}</h1>
    {#
      'n18' is the index of the node which corresponds to 'yes' in response
      to question 'Are you at immediate risk of harm?'
    #}
    {% if 'n18' in session.checker.diagnosis_previous_choices %}
      <div class="govuk-warning-text">
        <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
        <strong class="govuk-warning-text__text">
          {% trans %}If you’re in an emergency situation, please call the police on 999.{% endtrans %}
        </strong>
      </div>
      <p class="govuk-body">
        {% trans call_charges_link=Element.link_new_window('https://www.gov.uk/call-charges', _('Call charges apply'), True) %}
            If you’re in immediate danger please call Civil Legal Advice on <strong class="laa-telephone">0345 345 4 345</strong>.
            {{ call_charges_link }}.
          {% endtrans %}
      </p>
      <p class="govuk-body">
        {% trans %}You can also ask us to call you back using the form below, which is free.{% endtrans %}
      </p>
    {% else %}
      <p class="govuk-body">
        {% trans %}Please submit your details to get in touch with Civil Legal Advice (CLA).{% endtrans %}
      </p>
      <p class="govuk-body">
        {% trans call_charges_link=Element.link_new_window('https://www.gov.uk/call-charges', _('call charges'), True) %}
          You can choose to contact CLA yourself and speak to someone immediately
          (this is an 0345 number - {{ call_charges_link }} apply) or ask us to call you back, which is free.
        {% endtrans %}
      </p>
      <p class="govuk-body">
        {{ _('You’ll need to provide evidence of the financial information (if any) you’ve given us through this service.') }}
      </p>
    {% endif %}
  {% endblock %}

  <form method="POST" action="{{ url_for('contact.get_in_touch') }}">
    {{ form.csrf_token }}
    {{ Form.handle_errors(form) }}

    {{ Form.group(form.full_name, field_attrs={'class': 'm-large', 'spellcheck': "false"}) }}

    {% call Form.fieldset(form.contact_type, field_as_label=True) %}
      <div class="govuk-radios">
        {%- for option in form.contact_type -%}
          <div class="govuk-radios__item">
            {{ option(**{"class": "govuk-radios__input"}) }}
            <label class="govuk-label govuk-radios__label" for="{{ option.id }}">
              {{ option.label.text }}
            </label>
          </div>
          {% if option.data == 'call' %}
            <div class="govuk-radios__conditional"
                 data-controlled-by="contact_type"
                 data-control-value="call" role="alert">
              <p class="govuk-body">
                {{ _('We’ll give you the CLA phone number when you submit your details below.') }}
              </p>
            </div>
          {% elif option.data == 'callback' %}
            {{ Subform.callback(form) }}
          {% elif option.data == 'thirdparty' %}
            {{ Subform.thirdparty(form) }}
          {% endif %}
        {% endfor %}
      </div>
    {% endcall %}

    {{ Form.group(form.email, field_attrs={'class': 'm-large'}) }}

    {% call Form.fieldset(form.address, field_as_label=True) %}
      {{ Form.group(form.address.post_code,
          'form-group-plain',
          field_attrs={'class': 'govuk-input--width-10', 'data-address-el': '#address-street_address', 'autocomplete': "postal-code", 'spellcheck': "false"},
          row_class='address-finder') }}

      {{ Form.group(form.address.street_address,
          'form-group-plain',
          field_attrs={'class': 'm-large', 'rows': 4}) }}
    {% endcall %}

    {% set max_length_validator = form.extra_notes.validators|selectattr('max')|first %}
    {% set max_length = max_length_validator.max if max_length_validator %}
    {{ Form.group(form.extra_notes, field_attrs={'class': 'm-full', 'rows': 7, 'data-character-count': max_length}) }}
    <div class="govuk-form-group">
      {{ Subform.adaptations(form.adaptations) }}
    </div>
    {{ Form.honeypot(form) }}
    {{ Form.actions(_('Submit details')) }}
  </form>
  {% include "checker/time-out-warning.html" %}
  {% block notice %}
    <p class="notice">
      {% trans privacy_link=Element.link_new_window(url_for('base.privacy'), _('Civil Legal Advice Privacy Statement')) %}
        Protecting your personal data and your privacy is important to us.
        Read the full {{ privacy_link }}.
      {% endtrans %}
    </p>
  {% endblock %}
{% endblock %}

{% block javascripts %}
  {{ super() }}

  {% if reasons_for_contacting -%}
    <script>
      ga('send', 'event', 'reasons-for-contacting', '{{ reasons_for_contacting }}');
    </script>
  {%- endif -%}

  <script type="text/html" id="addressFinderButton">
    <button class="button button-secondary address-finder-button" type="button">
      {{ _('Find UK address') }}
    </button>
  </script>

  <script type="text/html" id="addressFinderList">
    <div class="form-group form-subfield address-list">
      <select name="address" class="form-control">
        <option value="" disabled><%= count %> {{ _('addresses found') }}</option>
        <option value="">-- {{ _('Choose address') }} --</option>
        <% _.each(items, function(address, index) { %>
          <option value="<%= index %>"><%= address %></option>
        <% }); %>
      </select>
    </div>
  </script>

  <script type="text/html" id="characterCounter">
    <div class="character-counter <%= counter_class %>">
      <%= count %> {{ _('characters remaining') }}
    </div>
  </script>

  <script type="text/html" id="postcodeNotEnteredText">
    <span class="govuk-error-message">
      <span class="govuk-visually-hidden">{% trans %}Error{% endtrans %}:</span>
      <span class="cla-error-message">{{ _('Must contain a valid postcode') }}</span>
    </span>
  </script>

  <script type="text/html" id="noAddressesFoundText">
    <span class="govuk-error-message">
      <span class="govuk-visually-hidden">{% trans %}Error{% endtrans %}:</span>
      <span class="cla-error-message">{{ _('No addresses were found with that postcode, but you can still enter your address manually') }}</span>
    </span>
  </script>

  <script type="text/html" id="requestFailedText">
    <span class="govuk-error-message">
      <span class="govuk-visually-hidden">{% trans %}Error{% endtrans %}:</span>
      <span class="cla-error-message">{{ _('Request failed: ') }} <%= textStatus %>, <%= error %></span>
    </span>
  </script>
{% endblock %}
